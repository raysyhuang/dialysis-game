<!DOCTYPE html>
<html lang="zh" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="透析患者的AI营养追踪助手，帮助记录和分析日常饮食">
    <title>DietPal | 智能营养助手</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            /* Alma-inspired color scheme */
            --primary: #4F46E5;
            --primary-light: #818CF8;
            --primary-dark: #3730A3;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --background: #F8FAFC;
            --surface: #FFFFFF;
            --text-primary: #1F2937;
            --text-secondary: #6B7280;
            --border: #E5E7EB;
            
            /* Enhanced shadows */
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
            --shadow-md: 0 8px 12px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 12px 24px rgba(0, 0, 0, 0.12);
            
            /* Smooth transitions */
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        :root.dark {
            --primary: #6366F1;
            --primary-light: #818CF8;
            --primary-dark: #4F46E5;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --background: #111827;
            --surface: #1F2937;
            --text-primary: #F9FAFB;
            --text-secondary: #D1D5DB;
            --border: #374151;
            
            /* Adjusted shadows for dark mode */
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.2);
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.25);
            --shadow-md: 0 8px 12px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 12px 24px rgba(0, 0, 0, 0.35);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        .app-container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 2rem;
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 2.5rem;
            min-height: 100vh;
        }

        /* Enhanced Sidebar */
        .sidebar {
            background: var(--surface);
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: var(--shadow-lg);
            position: sticky;
            top: 2rem;
            height: fit-content;
            border: 1px solid var(--border);
        }

        .profile-section {
            text-align: center;
            margin-bottom: 2.5rem;
            position: relative;
        }

        .profile-avatar {
            width: 96px;
            height: 96px;
            border-radius: 50%;
            margin: 0 auto 1.25rem;
            background: var(--primary-light);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2.5rem;
            font-weight: 600;
            position: relative;
            box-shadow: var(--shadow-md);
        }

        .profile-avatar::after {
            content: '';
            position: absolute;
            width: 108px;
            height: 108px;
            border: 2px solid var(--primary-light);
            border-radius: 50%;
            top: -6px;
            left: -6px;
            opacity: 0.3;
        }

        .profile-name {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .profile-status {
            font-size: 0.875rem;
            color: var(--text-secondary);
            background: var(--background);
            padding: 0.5rem 1rem;
            border-radius: 1rem;
            display: inline-block;
        }

        /* Alma Score Section */
        .alma-score {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 1.25rem;
            padding: 1.5rem;
            color: white;
            margin-bottom: 2rem;
            text-align: center;
        }

        .alma-score-title {
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 1rem;
            opacity: 0.9;
        }

        .alma-score-value {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .alma-score-label {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        /* Enhanced Nutrient Progress */
        .nutrient-progress {
            background: var(--surface);
            border-radius: 1rem;
            padding: 1.25rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border);
            transition: var(--transition);
        }

        .nutrient-progress:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .progress-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .progress-bar {
            height: 8px;
            background: var(--background);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .progress-fill.warning {
            background: var(--warning);
        }

        .progress-fill.danger {
            background: var(--danger);
        }

        /* Main Content */
        .main-content {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            position: relative;
        }

        .header h1::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 0;
            width: 40px;
            height: 4px;
            background: var(--primary);
            border-radius: 2px;
        }

        /* Enhanced Meal Grid */
        .meal-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 1.5rem;
        }

        .meal-card {
            background: var(--surface);
            border-radius: 1.25rem;
            padding: 1.75rem;
            box-shadow: var(--shadow);
            transition: var(--transition);
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
            touch-action: pan-y;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .meal-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(to right, var(--primary), var(--primary-light));
            opacity: 0;
            transition: var(--transition);
        }

        .meal-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .meal-card:hover::before {
            opacity: 1;
        }

        .meal-time {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .meal-time i {
            color: var(--primary);
        }

        .meal-foods {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .food-tag {
            background: var(--background);
            padding: 0.625rem 1rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: var(--transition);
            border: 1px solid var(--border);
        }

        .food-tag:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .food-emoji {
            font-size: 1.25rem;
        }

        .meal-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border);
        }

        .stat-item {
            text-align: center;
            padding: 1rem;
            background: var(--background);
            border-radius: 1rem;
            transition: var(--transition);
        }

        .stat-item:hover {
            background: var(--primary);
        }

        .stat-item:hover .stat-value,
        .stat-item:hover .stat-label {
            color: white;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            transition: var(--transition);
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
            transition: var(--transition);
        }

        /* Enhanced Add Meal Button */
        .add-meal-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 4rem;
            height: 4rem;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            transition: var(--transition);
            transform-origin: center;
        }

        .add-meal-btn::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 2px solid var(--primary);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 0.8;
            }
            70% {
                transform: scale(1.5);
                opacity: 0;
            }
            100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }

        .add-meal-btn:hover {
            transform: scale(1.1);
            background: var(--primary-dark);
        }

        .add-meal-btn:active {
            transform: scale(0.9);
        }

        /* Enhanced Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--surface);
            border-radius: 1.5rem;
            padding: 2.5rem;
            width: 90%;
            max-width: 560px;
            max-height: 80vh;
            overflow-y: auto;
            transform: translateY(20px);
            transition: var(--transition);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border);
        }

        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.5rem;
            padding: 0.5rem;
            transition: var(--transition);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: var(--background);
            color: var(--primary);
        }

        /* Enhanced Input Methods */
        .input-methods {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .input-method {
            background: var(--background);
            border: 2px solid transparent;
            border-radius: 1.25rem;
            padding: 2rem 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            transform-origin: center;
        }

        .input-method:hover {
            background: var(--surface);
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .input-method.active {
            border-color: var(--primary);
            background: var(--surface);
            box-shadow: var(--shadow-md);
            transform: scale(1.05);
        }

        .input-method i {
            font-size: 2.5rem;
            color: var(--primary);
            margin-bottom: 1rem;
        }

        .input-method-label {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Enhanced Camera View */
        .camera-view {
            display: none;
            position: relative;
        }

        .camera-view.active {
            display: block;
        }

        #camera-feed {
            width: 100%;
            border-radius: 1.25rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-md);
        }

        .camera-controls {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
        }

        .camera-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 1rem;
            padding: 1rem 2rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .camera-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .camera-btn.secondary {
            background: var(--background);
            color: var(--text-primary);
        }

        .camera-btn.secondary:hover {
            background: var(--border);
        }

        /* Enhanced Text Input View */
        .text-input-view {
            display: none;
        }

        .text-input-view.active {
            display: block;
        }

        /* Photo Upload View */
        .upload-view {
            display: none;
        }

        .upload-view.active {
            display: block;
        }

        .upload-container {
            margin-bottom: 1.5rem;
        }

        .upload-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2.5rem;
            background: var(--background);
            border: 2px dashed var(--border);
            border-radius: 1rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .upload-label:hover, .upload-label.drag-over {
            background: var(--surface);
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .upload-label i {
            font-size: 3rem;
            color: var(--primary);
            margin-bottom: 1rem;
        }

        .upload-label span {
            font-size: 1rem;
            color: var(--text-secondary);
            text-align: center;
        }

        .upload-input {
            display: none;
        }

        .upload-preview-container {
            margin-bottom: 1.5rem;
            border-radius: 1rem;
            overflow: hidden;
            transition: var(--transition);
            max-height: 50vh;
        }

        .upload-preview {
            width: 100%;
            display: none;
            border-radius: 1rem;
            box-shadow: var(--shadow-md);
            max-height: 50vh;
            object-fit: contain;
        }

        /* Text Input Styles */
        .food-input-container {
            position: relative;
            margin-bottom: 1.5rem;
            width: 100%;
        }

        .food-input {
            width: 100%;
            padding: 1.5rem 1rem 1rem;
            border: 2px solid var(--border);
            border-radius: 0.75rem;
            font-size: 1rem;
            background: var(--surface);
            color: var(--text-primary);
            transition: var(--transition);
            min-height: 120px;
            resize: vertical;
        }

        .food-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
        }

        .food-input::placeholder {
            color: var(--text-secondary);
            opacity: 0;
        }

        .food-input-label {
            position: absolute;
            top: 1.25rem;
            left: 1.25rem;
            font-size: 1rem;
            color: var(--text-secondary);
            pointer-events: none;
            transition: all 0.3s ease;
            background: transparent;
        }

        .food-input:focus + .food-input-label,
        .food-input:not(:placeholder-shown) + .food-input-label {
            top: 0.5rem;
            left: 1rem;
            font-size: 0.75rem;
            color: var(--primary);
        }

        .submit-btn {
            width: 100%;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 1rem;
            padding: 1.25rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            position: sticky;
            bottom: 0;
            margin-top: 1rem;
        }

        .submit-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .app-container {
                grid-template-columns: 1fr;
                padding: 1.5rem;
            }

            .sidebar {
                position: static;
                margin-bottom: 2rem;
            }

            .meal-grid {
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            }
        }

        @media (max-width: 640px) {
            .header h1 {
                font-size: 1.5rem;
            }

            .meal-card {
                padding: 1.25rem;
            }

            .input-methods {
                grid-template-columns: 1fr;
            }

            .camera-controls {
                flex-direction: column;
            }

            .camera-btn {
                width: 100%;
            }

            .upload-label {
                padding: 1.5rem;
            }
        }

        /* Add styles for the notification close button */
        .notification-close {
            background: none;
            border: none;
            cursor: pointer;
            color: inherit;
            margin-left: 10px;
            padding: 4px;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease;
        }
        
        .notification-close:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }
        
        .notification-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }
        
        /* Error dialog */
        .error-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            z-index: 2001;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
        
        .error-dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 2000;
        }
        
        .error-dialog-message {
            margin-bottom: 20px;
            color: var(--text-primary);
            font-size: 16px;
        }
        
        .error-dialog-button {
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .error-dialog-button:hover {
            background-color: var(--primary-dark);
        }

        /* Enhanced Interactions */
        .meal-card-actions {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .meal-card:hover .meal-card-actions {
            opacity: 1;
        }

        .meal-card-action {
            background: var(--background);
            color: var(--text-secondary);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-left: 0.5rem;
            transition: all 0.2s ease;
        }

        .meal-card-action:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.1);
        }

        .meal-card-action.delete {
            color: var(--danger);
        }

        .meal-card-action.delete:hover {
            background: var(--danger);
            color: white;
        }

        /* Pulse animation for notifying users of an action */
        @keyframes pulseHighlight {
            0% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(79, 70, 229, 0); }
            100% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0); }
        }

        .pulse-highlight {
            animation: pulseHighlight 1.5s ease-out;
        }

        /* Input method transitions */
        .input-method {
            transform-origin: center;
            transition: transform 0.3s ease, background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .input-method.active {
            transform: scale(1.05);
        }

        /* Bottom Tooltip */
        .tooltip {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .tooltip.visible {
            opacity: 1;
        }

        /* Back to top button */
        .back-to-top {
            position: fixed;
            bottom: 2rem;
            left: 2rem;
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow-md);
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease, transform 0.3s ease, background-color 0.3s ease;
            z-index: 100;
        }

        .back-to-top.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .back-to-top:hover {
            background: var(--primary-dark);
        }

        /* Ghost loading placeholder */
        @keyframes shimmer {
            0% { background-position: -468px 0 }
            100% { background-position: 468px 0 }
        }

        .ghost-loader {
            background: linear-gradient(to right, #f6f7f8 8%, #edeef1 18%, #f6f7f8 33%);
            background-size: 800px 104px;
            animation: shimmer 1.25s infinite linear;
            border-radius: 0.5rem;
        }

        /* Empty state */
        .empty-state {
            padding: 3rem;
            text-align: center;
            background: var(--surface);
            border-radius: 1rem;
            border: 2px dashed var(--border);
            margin: 2rem 0;
        }

        .empty-state i {
            font-size: 3rem;
            color: var(--primary-light);
            margin-bottom: 1rem;
        }

        .empty-state-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .empty-state-description {
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
        }

        .empty-state-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 0.5rem;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .empty-state-btn:hover {
            background: var(--primary-dark);
        }

        /* Enhanced Input Method Selection */
        .input-method {
            position: relative;
            overflow: hidden;
        }

        .input-method::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 3px;
            background: var(--primary);
            transform: translateX(-50%);
            transition: width 0.3s ease;
        }

        .input-method.active::after {
            width: 80%;
        }

        /* Enhance the photo upload experience */
        .upload-label {
            position: relative;
            overflow: hidden;
        }

        .upload-label::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--primary);
            opacity: 0;
            transition: opacity 0.3s ease;
            border-radius: 1rem;
            z-index: 0;
        }

        .upload-label:hover::before {
            opacity: 0.05;
        }

        .upload-label i, .upload-label span {
            position: relative;
            z-index: 1;
        }

        /* Ripple effect for buttons */
        .ripple {
            position: relative;
            overflow: hidden;
        }

        .ripple::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            background-image: radial-gradient(circle, rgba(255, 255, 255, 0.3) 10%, transparent 10.01%);
            background-repeat: no-repeat;
            background-position: 50%;
            transform: scale(10, 10);
            opacity: 0;
            transition: transform 0.5s, opacity 0.5s;
        }

        .ripple:active::after {
            transform: scale(0, 0);
            opacity: 0.3;
            transition: 0s;
        }

        /* Enhanced Touch Feedback */
        .submit-btn, .camera-btn, .meal-card-action, .add-meal-btn, .back-to-top {
            -webkit-tap-highlight-color: transparent;
        }

        /* Accessibile focus styles */
        .submit-btn:focus, .camera-btn:focus, .input-method:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.3);
        }

        /* Floating label for text input */
        /* These styles are now consolidated above */

        .voice-input-btn {
            position: absolute;
            right: 10px;
            bottom: 10px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
        }

        .voice-input-btn:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
        }

        .voice-input-btn.listening {
            animation: pulse 1.5s infinite;
            background: var(--danger);
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* Add ripple animation keyframes */
        @keyframes ripple-effect {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(2);
                opacity: 0;
            }
        }

        /* Improved camera controls for mobile */
        @media (max-width: 640px) {
            .camera-controls {
                position: relative;
                padding-bottom: 60px;
            }
            
            .camera-btn {
                position: absolute;
                bottom: 0;
                left: 0;
                width: 100%;
                margin: 0;
            }
            
            .camera-btn:first-child {
                bottom: 0;
            }
            
            .camera-btn:last-child {
                bottom: 60px;
            }
            
            /* Make action buttons more visible on mobile */
            .meal-card-actions {
                opacity: 1;
                top: 0.5rem;
                right: 0.5rem;
            }
            
            /* Fix upload button for long photos on mobile */
            .upload-view {
                display: flex;
                flex-direction: column;
                min-height: 300px;
            }
            
            .upload-preview-container {
                flex: 1;
                min-height: 150px;
            }
            
            /* Better food tags display on mobile */
            .food-tag {
                padding: 0.5rem 0.75rem;
                margin-bottom: 0.25rem;
            }
            
            /* Keep back to top button visible on mobile */
            .back-to-top {
                bottom: 6rem;
                width: 2.5rem;
                height: 2.5rem;
            }
        }

        /* Add keyframe animations for interactions */
        @keyframes ripple-effect {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(2);
                opacity: 0;
            }
        }

        @keyframes pulse-highlight {
            0% { 
                transform: scale(1); 
                box-shadow: 0 0 0 0 rgba(var(--primary-rgb), 0.7); 
            }
            70% { 
                transform: scale(1.05); 
                box-shadow: 0 0 0 10px rgba(var(--primary-rgb), 0); 
            }
            100% { 
                transform: scale(1); 
                box-shadow: 0 0 0 0 rgba(var(--primary-rgb), 0); 
            }
        }

        /* Enhanced mobile experience */
        @media (max-width: 640px) {
            /* Improve camera controls layout */
            .camera-controls {
                position: relative;
                padding-bottom: 60px;
            }
            
            .camera-btn {
                position: absolute;
                bottom: 0;
                left: 0;
                width: 100%;
                margin: 0;
            }
            
            .camera-btn:first-child {
                bottom: 0;
            }
            
            .camera-btn:last-child {
                bottom: 60px;
            }
            
            /* Better meal card spacing */
            .meal-card {
                margin-bottom: 1rem;
            }
            
            /* More visible action buttons */
            .meal-card-actions {
                opacity: 1;
                top: 0.5rem;
                right: 0.5rem;
            }
            
            /* Improved photo upload layout */
            .upload-view {
                display: flex;
                flex-direction: column;
                min-height: 300px;
            }
            
            .upload-preview-container {
                flex: 1;
                min-height: 150px;
            }
            
            /* Better food tag display */
            .food-tag {
                padding: 0.5rem 0.75rem;
                margin-bottom: 0.25rem;
            }
            
            /* Better positioning for back to top button */
            #backToTopBtn {
                bottom: 6rem;
                right: 1rem;
                width: 2.5rem;
                height: 2.5rem;
            }
            
            /* Improved nutrient progress spacing */
            .nutrient-progress {
                margin-bottom: 1.25rem;
            }
        }

        /* Add Double-tap highlight effect */
        @keyframes tap-highlight {
            0% { background-color: transparent; }
            50% { background-color: rgba(var(--primary-rgb), 0.1); }
            100% { background-color: transparent; }
        }

        /* Enhanced floating action button */
        #addMealBtn {
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), 
                        box-shadow 0.3s ease;
        }

        #addMealBtn:hover, #addMealBtn:focus {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }

        /* Improved scrollbar for better UX */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 10px;
            transition: background 0.3s;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

        /* Improved focus styles for accessibility */
        button:focus, input:focus, .input-method:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.3);
        }

        /* Dark mode toggle */
        .theme-toggle {
            text-align: center;
            margin-top: 1rem;
        }

        .theme-toggle-btn {
            background: none;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 1.5rem;
            transition: color 0.3s ease;
        }

        .theme-toggle-btn:hover {
            color: var(--primary);
        }

        /* Nutrient details modal */
        .modal.nutrient-details-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1001;
            align-items: center;
            justify-content: center;
        }
        
        .modal.nutrient-details-modal.active {
            display: flex;
        }
        
        .modal.nutrient-details-modal.active .modal-content {
            transform: translateY(0);
            opacity: 1;
        }
        
        .modal.nutrient-details-modal .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border);
        }
        
        .modal.nutrient-details-modal .close-btn {
            background: none;
            border: none;
            font-size: 1.25rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: color 0.2s ease;
        }
        
        .modal.nutrient-details-modal .close-btn:hover {
            color: var(--text-primary);
        }
        
        .modal.nutrient-details-modal .modal-body {
            padding: 1.5rem;
        }
        
        .nutrient-detail-item {
            margin-bottom: 1.5rem;
        }
        
        .nutrient-detail-item h4 {
            margin-bottom: 0.5rem;
            color: var(--primary);
            font-weight: 600;
        }
        
        .food-source-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .food-source-item {
            background-color: var(--primary-light);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.875rem;
        }
        
        .nutrient-chart-container {
            margin: 1.5rem 0;
            height: 200px;
        }
        
        .nutrient-recommendations {
            background-color: rgba(var(--primary-rgb), 0.1);
            padding: 1rem;
            border-radius: 0.75rem;
            margin-top: 1.5rem;
        }
        
        .nutrient-recommendations h4 {
            color: var(--primary);
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        
        .nutrient-progress {
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .nutrient-progress:hover {
            transform: translateY(-2px);
        }

        .modal.nutrient-details-modal.active {
            display: flex;
        }
        
        .nutrient-details-modal .modal-content {
            background-color: var(--surface);
            border-radius: 1rem;
            padding: 1.5rem;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            transform: translateY(20px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        
        .modal.nutrient-details-modal.active .modal-content {
            transform: translateY(0);
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="profile-section">
                <div class="profile-avatar">
                    <span>张</span>
                </div>
                <h2 class="profile-name">张先生</h2>
                <p class="profile-status">透析日：周一、三、五</p>
            </div>

            <div class="alma-score">
                <div class="alma-score-title">今日营养评分</div>
                <div class="alma-score-value">85</div>
                <div class="alma-score-label">良好饮食习惯</div>
            </div>

            <div class="nutrient-progress">
                <div class="progress-title">
                    <span>蛋白质</span>
                    <span>65/80g</span>
                    </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 81.25%"></div>
                    </div>
                    </div>

            <div class="nutrient-progress">
                <div class="progress-title">
                    <span>磷</span>
                    <span>750/1000mg</span>
                    </div>
                    <div class="progress-bar">
                    <div class="progress-fill" style="width: 75%"></div>
                    </div>
                </div>

            <div class="nutrient-progress">
                <div class="progress-title">
                    <span>钾</span>
                    <span>1600/2000mg</span>
                </div>
                    <div class="progress-bar">
                    <div class="progress-fill warning" style="width: 80%"></div>
                    </div>
                </div>

            <div class="nutrient-progress">
                <div class="progress-title">
                    <span>钠</span>
                    <span>1800/2000mg</span>
                </div>
                    <div class="progress-bar">
                    <div class="progress-fill danger" style="width: 90%"></div>
                    </div>
                </div>

            <!-- Dark mode toggle -->
            <div class="theme-toggle">
                <button id="darkModeToggle" class="theme-toggle-btn">
                    <i class="fas fa-moon"></i>
                    <span>切换深色模式</span>
                </button>
            </div>
        </aside>

        <main class="main-content">
            <div class="header">
                <h1>今日饮食记录</h1>
            </div>

            <div class="meal-grid">
                <div class="empty-state">
                    <i class="fas fa-utensils"></i>
                    <h3 class="empty-state-title">没有饮食记录</h3>
                    <p class="empty-state-description">点击右下角的加号按钮添加您的第一条饮食记录</p>
                </div>
            </div>
        </main>
    </div>

    <button class="add-meal-btn" id="addMealBtn">
        <i class="fas fa-plus"></i>
    </button>

    <div class="modal-overlay" id="addMealModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">添加饮食记录</h3>
                <button class="modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="input-methods">
                <div class="input-method" data-method="camera">
                    <i class="fas fa-camera"></i>
                    <div class="input-method-label">拍照记录</div>
                </div>
                <div class="input-method" data-method="upload">
                    <i class="fas fa-upload"></i>
                    <div class="input-method-label">上传照片</div>
                </div>
                <div class="input-method" data-method="text">
                    <i class="fas fa-keyboard"></i>
                    <div class="input-method-label">文字输入</div>
                </div>
            </div>

            <div class="camera-view" id="cameraView">
                <video id="camera-feed" autoplay playsinline></video>
                <div class="camera-controls">
                    <button class="camera-btn" id="captureBtn">
                        <i class="fas fa-camera"></i>
                        拍照
                    </button>
                    <button class="camera-btn secondary" id="switchCameraBtn">
                        <i class="fas fa-sync"></i>
                        切换相机
                    </button>
                </div>
            </div>

            <div class="text-input-view" id="textInputView">
                <div class="food-input-container">
                    <textarea class="food-input" id="foodTextarea" placeholder=""></textarea>
                    <label class="food-input-label" for="foodTextarea">请描述您的食物，例如：一碗米饭，两个鸡蛋，一盘炒青菜</label>
                    <button class="voice-input-btn" id="voiceInputBtn" title="语音输入">
                        <i class="fas fa-microphone"></i>
                    </button>
                </div>
                <button class="submit-btn ripple" id="submitTextBtn">
                    <i class="fas fa-check"></i>
                    确认添加
                </button>
            </div>

            <div class="upload-view" id="uploadView">
                <div class="upload-container">
                    <label for="photoUpload" class="upload-label">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <span>点击上传照片或拖拽照片到此处</span>
                    </label>
                    <input type="file" id="photoUpload" accept="image/*" class="upload-input" />
                </div>
                <div class="upload-preview-container">
                    <img id="uploadPreview" class="upload-preview" />
                </div>
                <button class="submit-btn ripple" id="submitUploadBtn">
                    <i class="fas fa-check"></i>
                    确认上传
                </button>
            </div>
        </div>
    </div>

    <button class="back-to-top" id="backToTopBtn">
        <i class="fas fa-arrow-up"></i>
    </button>

    <div class="tooltip" id="tooltip"></div>

    <!-- Nutrient details modal -->
    <div class="modal nutrient-details-modal" id="nutrientDetailsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>营养素详情</h3>
                <button class="close-btn nutrient-details-close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="nutrient-detail-item current-intake">
                    <h4>当前摄入量</h4>
                    <p class="nutrient-current-value">0g / 推荐 0g</p>
                    <div class="nutrient-percentage">0%</div>
                </div>
                
                <div class="nutrient-detail-item description">
                    <h4>营养素说明</h4>
                    <p class="nutrient-description">加载中...</p>
                </div>
                
                <div class="nutrient-detail-item sources">
                    <h4>食物来源</h4>
                    <div class="food-source-list">
                        <!-- Food sources will be added dynamically -->
                    </div>
                </div>
                
                <div class="nutrient-chart-container">
                    <canvas id="nutrientTrendChart"></canvas>
                </div>
                
                <div class="nutrient-recommendations">
                    <h4>个性化建议</h4>
                    <p class="recommendation-text">加载中...</p>
                </div>
            </div>
        </div>
    </div>
    
    <script src="js/nutrient-details.js"></script>
    
    <script>
        // Initialize everything when the DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializeModal();
            initializeDragAndDrop();
            initializeDarkMode();
            initializeSubmitButtons(); // Initialize submit buttons
        });

        // Nutrition database for consistent analysis
        const nutritionDatabase = {
            '米饭': { protein: 3, phosphorus: 43, potassium: 35, sodium: 1, calories: 130 },
            '面条': { protein: 5, phosphorus: 49, potassium: 44, sodium: 2, calories: 138 },
            '鸡蛋': { protein: 6, phosphorus: 86, potassium: 69, sodium: 71, calories: 78 },
            '面包': { protein: 4, phosphorus: 64, potassium: 108, sodium: 170, calories: 75 },
            '牛奶': { protein: 3.4, phosphorus: 93, potassium: 150, sodium: 43, calories: 42 },
            '豆浆': { protein: 3.6, phosphorus: 47, potassium: 141, sodium: 14, calories: 31 },
            '豆腐': { protein: 8, phosphorus: 83, potassium: 121, sodium: 7, calories: 76 },
            '鸡肉': { protein: 27, phosphorus: 155, potassium: 220, sodium: 66, calories: 165 },
            '牛肉': { protein: 26, phosphorus: 178, potassium: 305, sodium: 54, calories: 250 },
            '猪肉': { protein: 22, phosphorus: 152, potassium: 289, sodium: 55, calories: 242 },
            '鱼': { protein: 20, phosphorus: 190, potassium: 300, sodium: 60, calories: 100 },
            '西红柿': { protein: 0.9, phosphorus: 24, potassium: 237, sodium: 5, calories: 18 },
            '黄瓜': { protein: 0.6, phosphorus: 21, potassium: 136, sodium: 2, calories: 15 },
            '青菜': { protein: 1.5, phosphorus: 30, potassium: 180, sodium: 35, calories: 20 },
            '米粉': { protein: 3.2, phosphorus: 40, potassium: 30, sodium: 1, calories: 109 },
            '馒头': { protein: 5.5, phosphorus: 67, potassium: 46, sodium: 230, calories: 223 },
            '饺子': { protein: 8, phosphorus: 62, potassium: 65, sodium: 120, calories: 180 },
            '水果': { protein: 0.5, phosphorus: 20, potassium: 200, sodium: 2, calories: 70 },
            '炒菜': { protein: 5, phosphorus: 60, potassium: 150, sodium: 170, calories: 100 },
            '蔬菜': { protein: 1.2, phosphorus: 25, potassium: 170, sodium: 20, calories: 25 },
            '肉': { protein: 22, phosphorus: 160, potassium: 270, sodium: 60, calories: 250 },
        };

        // Helper function to analyze food items consistently 
        function analyzeFoodItems(foodItems) {
            let totalProtein = 0;
            let totalPhosphorus = 0;
            let totalPotassium = 0;
            let totalSodium = 0;
            
            // Default serving size multiplier (can be adjusted for portion size)
            const defaultServing = 1;
            
            // Process each food item
            foodItems.forEach(item => {
                item = item.trim();
                if (!item) return;
                
                // Check if the item contains quantity indicators
                let quantity = defaultServing;
                let foodName = item;
                
                // Look for quantity patterns like "一碗", "两个", "半份", etc.
                const quantityPatterns = {
                    '一': 1, '两': 2, '三': 3, '四': 4, '五': 5, 
                    '1': 1, '2': 2, '3': 3, '4': 4, '5': 5,
                    '半': 0.5, '一半': 0.5
                };
                
                // Check for quantity indicators
                for (const [pattern, value] of Object.entries(quantityPatterns)) {
                    if (item.startsWith(pattern)) {
                        // For items like "一碗米饭", extract "米饭" as the food
                        const measureWords = ['碗', '个', '份', '片', '盘', '杯', '块'];
                        for (const measure of measureWords) {
                            if (item.includes(pattern + measure)) {
                                quantity = value;
                                foodName = item.substring(pattern.length + measure.length);
                                break;
                            }
                        }
                        break;
                    }
                }
                
                // Search for the food in the database
                // First try exact match
                let nutrition = nutritionDatabase[foodName];
                
                // If not found, try partial matching
                if (!nutrition) {
                    for (const [dbFood, dbNutrition] of Object.entries(nutritionDatabase)) {
                        if (foodName.includes(dbFood)) {
                            nutrition = dbNutrition;
                            break;
                        }
                    }
                }
                
                // If still not found, use default values
                if (!nutrition) {
                    nutrition = { 
                        protein: 4, 
                        phosphorus: 50, 
                        potassium: 100, 
                        sodium: 50, 
                        calories: 100 
                    };
                }
                
                // Add to running totals, adjusting for quantity
                totalProtein += nutrition.protein * quantity;
                totalPhosphorus += nutrition.phosphorus * quantity;
                totalPotassium += nutrition.potassium * quantity;
                totalSodium += nutrition.sodium * quantity;
            });
            
            // Round values to make them look more natural
            return {
                proteins: Math.round(totalProtein),
                phosphorus: Math.round(totalPhosphorus),
                potassium: Math.round(totalPotassium),
                sodium: Math.round(totalSodium)
            };
        }

        // Initialize modal functionality
        function initializeModal() {
            const addMealBtn = document.getElementById('addMealBtn');
            const addMealModal = document.getElementById('addMealModal');
            const modalClose = document.querySelector('.modal-close');
            const inputMethods = document.querySelectorAll('.input-method');
            const cameraView = document.getElementById('cameraView');
            const textInputView = document.getElementById('textInputView');
            const uploadView = document.getElementById('uploadView');
            
            // Open modal when add meal button is clicked
            addMealBtn.addEventListener('click', function() {
                addMealModal.classList.add('active');
                // Default to text input method
                showInputMethod('text');
            });
            
            // Close modal when close button is clicked
            modalClose.addEventListener('click', function() {
                addMealModal.classList.remove('active');
                stopCameraIfActive();
            });
            
            // Switch between input methods
            inputMethods.forEach(method => {
                method.addEventListener('click', function() {
                    const methodType = this.getAttribute('data-method');
                    showInputMethod(methodType);
                    
                    // Remove active class from all methods
                    inputMethods.forEach(m => m.classList.remove('active'));
                    // Add active class to selected method
                    this.classList.add('active');
                });
            });
            
            // Function to show selected input method
            function showInputMethod(methodType) {
                // Hide all views
                cameraView.classList.remove('active');
                textInputView.classList.remove('active');
                uploadView.classList.remove('active');
                
                // Show selected view
                if (methodType === 'camera') {
                    cameraView.classList.add('active');
                    initializeCamera();
                } else if (methodType === 'text') {
                    textInputView.classList.add('active');
                    // Auto-focus the text input for better UX
                    document.getElementById('foodTextarea').focus();
                } else if (methodType === 'upload') {
                    uploadView.classList.add('active');
                    initializeDragAndDrop();
                }
            }
            
            // Stop camera if it's active
            function stopCameraIfActive() {
                if (window.streamReference) {
                    window.streamReference.getTracks().forEach(track => track.stop());
                    window.streamReference = null;
                }
            }
        }
        
        // Initialize camera functionality
        function initializeCamera() {
            const cameraFeed = document.getElementById('camera-feed');
            const captureBtn = document.getElementById('captureBtn');
            const switchCameraBtn = document.getElementById('switchCameraBtn');
            
            // Check if we have previously initialized facingMode
            if (!window.currentFacingMode) {
                window.currentFacingMode = 'environment'; // Default to back camera
            }
            
            // Camera constraints
            const constraints = {
                video: { facingMode: window.currentFacingMode }
            };
            
            // Access the device camera
            navigator.mediaDevices.getUserMedia(constraints)
                .then(function(stream) {
                    window.streamReference = stream;
                    cameraFeed.srcObject = stream;
                })
                .catch(function(err) {
                    console.error("Error accessing camera: ", err);
                    showTooltip("无法访问摄像头，请检查权限设置");
                });
            
            // Capture photo button
            captureBtn.addEventListener('click', function() {
                const cameraFeed = document.getElementById('camera-feed');
                // Create a canvas to capture the photo
                const canvas = document.createElement('canvas');
                canvas.width = cameraFeed.videoWidth;
                canvas.height = cameraFeed.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(cameraFeed, 0, 0, canvas.width, canvas.height);
                
                // Convert canvas to image data
                canvas.toBlob(function(blob) {
                    addMeal('photo', blob);
                    addMealModal.classList.remove('active'); // Close the modal
                    stopCameraIfActive(); // Stop camera after capture
                    showTooltip('饮食记录已添加！');
                }, 'image/jpeg');
            });
            
        }
        
        // Initialize submit buttons functionality
        function initializeSubmitButtons() {
            const submitTextBtn = document.getElementById('submitTextBtn');
            const submitUploadBtn = document.getElementById('submitUploadBtn');
            const foodTextarea = document.getElementById('foodTextarea');
            const addMealModal = document.getElementById('addMealModal');
            
            // Handle text submission
            submitTextBtn.addEventListener('click', function() {
                const foodText = foodTextarea.value.trim();
                if (foodText) {
                    addMeal('text', foodText);
                    foodTextarea.value = ''; // Clear the input
                    addMealModal.classList.remove('active'); // Close the modal
                    showTooltip('饮食记录已添加！');
                } else {
                    showTooltip('请先描述您的食物');
                }
            });
            
            // Handle photo upload submission
            submitUploadBtn.addEventListener('click', function() {
                const photoUpload = document.getElementById('photoUpload');
                if (photoUpload.files && photoUpload.files[0]) {
                    addMeal('photo', photoUpload.files[0]);
                    photoUpload.value = ''; // Clear the input
                    document.getElementById('uploadPreview').style.display = 'none'; // Hide preview
                    addMealModal.classList.remove('active'); // Close the modal
                    showTooltip('饮食记录已添加！');
                } else {
                    showTooltip('请先上传照片');
                }
            });
            
            // Add capture photo submission handler
            const captureBtn = document.getElementById('captureBtn');
            captureBtn.addEventListener('click', function() {
                const cameraFeed = document.getElementById('camera-feed');
                // Create a canvas to capture the photo
                const canvas = document.createElement('canvas');
                canvas.width = cameraFeed.videoWidth;
                canvas.height = cameraFeed.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(cameraFeed, 0, 0, canvas.width, canvas.height);
                
                // Convert canvas to image data
                canvas.toBlob(function(blob) {
                    addMeal('photo', blob);
                    addMealModal.classList.remove('active'); // Close the modal
                    stopCameraIfActive(); // Stop camera after capture
                    showTooltip('饮食记录已添加！');
                }, 'image/jpeg');
            });
        }

        // Add meal function
        function addMeal(type, data) {
            // Get current time
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const timeStr = `${hours}:${minutes}`;
            
            // Determine meal type based on time
            let mealType;
            if (hours < 10) {
                mealType = '早餐';
            } else if (hours < 14) {
                mealType = '午餐';
            } else if (hours < 18) {
                mealType = '点心';
            } else {
                mealType = '晚餐';
            }
            
            // Create meal card
            const mealCard = document.createElement('div');
            mealCard.className = 'meal-card';
            
            let foodItems = [];
            let proteins = 0;
            let phosphorus = 0;
            
            if (type === 'text') {
                // Parse text input to extract food items
                const foodText = data;
                foodItems = foodText.split(/[,，、]/);
                
                // Get nutrition data from our database
                const nutritionInfo = analyzeFoodItems(foodItems);
                proteins = nutritionInfo.proteins;
                phosphorus = nutritionInfo.phosphorus;
                
                // Set data attributes for nutrition tracking
                mealCard.dataset.proteins = proteins;
                mealCard.dataset.phosphorus = phosphorus;
                mealCard.dataset.potassium = nutritionInfo.potassium;
                mealCard.dataset.sodium = nutritionInfo.sodium;
            } else if (type === 'photo') {
                // Initial placeholder for photo analysis
                foodItems = ['正在分析...'];
                proteins = '--';
                phosphorus = '--';
                
                // Create a unique ID for this meal card to reference it later
                const cardId = 'meal-card-' + Date.now();
                mealCard.id = cardId;
                
                // Save the image data to associate with the card
                if (type === 'photo' && data instanceof Blob) {
                    // Store the image URL temporarily to use for analysis
                    const imageUrl = URL.createObjectURL(data);
                    mealCard.dataset.imageUrl = imageUrl;
                }
                
                // Simulate server-side analysis after a delay
                setTimeout(() => {
                    // In a real app, we would analyze the actual image
                    // For this demo, we'll simulate by picking random foods
                    // But use consistent nutritional values for each food
                    const possibleFoods = ['米饭', '面条', '鸡蛋', '面包', '鸡肉', '牛肉', '猪肉', '豆腐', '西红柿', '黄瓜', '青菜', '米粉', '馒头', '饺子', '水果'];
                    const analyzedFoods = [];
                    
                    // For demo purposes, select a consistent set of foods based on the time
                    // This ensures the same image will get the same foods if uploaded at the same time
                    const seed = Date.now() % 100; // Use the current time as a seed
                    const foodCount = 2 + (seed % 3); // 2-4 items
                    
                    // Select foods based on the seed
                    for (let i = 0; i < foodCount; i++) {
                        const index = (seed + i * 7) % possibleFoods.length; // Use a formula to select food
                        analyzedFoods.push(possibleFoods[index]);
                    }
                    
                    // Get nutrition data for these foods from our database
                    const nutritionInfo = analyzeFoodItems(analyzedFoods);
                    
                    // Get reference to the card and update its contents
                    const card = document.getElementById(cardId);
                    if (card) {
                        const foodsContainer = card.querySelector('.meal-foods');
                        const proteinValue = card.querySelector('.stat-item:first-child .stat-value');
                        const phosphorusValue = card.querySelector('.stat-item:last-child .stat-value');
                        
                        // Update food items
                        foodsContainer.innerHTML = generateFoodTags(analyzedFoods);
                        
                        // Update nutrition values with animation
                        proteinValue.textContent = nutritionInfo.proteins + 'g';
                        phosphorusValue.textContent = nutritionInfo.phosphorus + 'mg';
                        
                        // Set data attributes for nutrition tracking
                        card.dataset.proteins = nutritionInfo.proteins;
                        card.dataset.phosphorus = nutritionInfo.phosphorus;
                        card.dataset.potassium = nutritionInfo.potassium;
                        card.dataset.sodium = nutritionInfo.sodium;
                        
                        // Add highlight effect to show the card has been updated
                        card.classList.add('pulse-highlight');
                        
                        // Show a notification
                        showTooltip('食物分析完成！');
                        
                        // Update nutrition panels
                        updateNutritionPanels();
                    }
                }, 2000); // 2 second delay to simulate analysis
            }
            
            // Create meal card HTML
            mealCard.innerHTML = `
                <div class="meal-time">
                    <i class="fas fa-clock"></i>
                    ${mealType} ${timeStr}
                </div>
                <div class="meal-card-actions">
                    <button class="meal-card-action delete" title="删除" onclick="deleteMealCard(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                <div class="meal-foods">
                    ${generateFoodTags(foodItems)}
                </div>
                <div class="meal-stats">
                    <div class="stat-item">
                        <div class="stat-value">${proteins}g</div>
                        <div class="stat-label">蛋白质</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${phosphorus}mg</div>
                        <div class="stat-label">磷</div>
                    </div>
                </div>
            `;
            
            // Add meal card to grid
            const mealGrid = document.querySelector('.meal-grid');
            
            // Check if empty state exists and remove it
            const emptyState = mealGrid.querySelector('.empty-state');
            if (emptyState) {
                emptyState.remove();
            }
            
            mealGrid.insertBefore(mealCard, mealGrid.firstChild);
            
            // Apply animation
            setTimeout(() => {
                mealCard.classList.add('pulse-highlight');
            }, 100);
            
            // Update the nutrition panels if we have nutrition data already
            if (type === 'text') {
                updateNutritionPanels();
            }
        }

        // Helper function to generate food tags
        function generateFoodTags(foodItems) {
            // Map of common food items to emojis
            const foodEmojis = {
                '米饭': '🍚',
                '面条': '🍜',
                '鸡蛋': '🥚',
                '面包': '🍞',
                '牛奶': '🥛',
                '豆浆': '🥛',
                '水果': '🍎',
                '蔬菜': '🥦',
                '鱼': '🐟',
                '肉': '🍖',
                '鸡肉': '🍗',
                '炒菜': '🥘'
            };
            
            return foodItems.map(item => {
                item = item.trim();
                if (!item) return '';
                
                // Find matching emoji or use default
                let emoji = '🍽️';
                for (const [food, foodEmoji] of Object.entries(foodEmojis)) {
                    if (item.includes(food)) {
                        emoji = foodEmoji;
                        break;
                    }
                }
                
                return `
                    <span class="food-tag">
                        <span class="food-emoji">${emoji}</span>
                        ${item}
                    </span>
                `;
            }).join('');
        }
        
        // Function to update nutrition panels based on meal cards
        function updateNutritionPanels() {
            const mealCards = document.querySelectorAll('.meal-card');
            
            // Define nutrient totals
            let totalProteins = 0;
            let totalPhosphorus = 0;
            let totalPotassium = 0;
            let totalSodium = 0;
            
            // Define nutrient targets
            const proteinTarget = 80;
            const phosphorusTarget = 1000;
            const potassiumTarget = 2000;
            const sodiumTarget = 2000;
            
            // Calculate totals from all meal cards
            mealCards.forEach(card => {
                // Skip cards that don't have nutrition data yet (like cards in analysis)
                if (card.dataset.proteins && card.dataset.proteins !== '--') {
                    totalProteins += parseInt(card.dataset.proteins);
                }
                
                if (card.dataset.phosphorus && card.dataset.phosphorus !== '--') {
                    totalPhosphorus += parseInt(card.dataset.phosphorus);
                }
                
                if (card.dataset.potassium) {
                    totalPotassium += parseInt(card.dataset.potassium);
                }
                
                if (card.dataset.sodium) {
                    totalSodium += parseInt(card.dataset.sodium);
                }
            });
            
            // Update protein panel
            const proteinPanel = document.querySelector('.nutrient-progress:nth-child(1)');
            const proteinValue = proteinPanel.querySelector('.progress-title span:last-child');
            const proteinFill = proteinPanel.querySelector('.progress-fill');
            
            proteinValue.textContent = `${totalProteins}/${proteinTarget}g`;
            let proteinPercentage = Math.min(100, (totalProteins / proteinTarget) * 100);
            proteinFill.style.width = `${proteinPercentage}%`;
            
            // Update phosphorus panel
            const phosphorusPanel = document.querySelector('.nutrient-progress:nth-child(2)');
            const phosphorusValue = phosphorusPanel.querySelector('.progress-title span:last-child');
            const phosphorusFill = phosphorusPanel.querySelector('.progress-fill');
            
            phosphorusValue.textContent = `${totalPhosphorus}/${phosphorusTarget}mg`;
            let phosphorusPercentage = Math.min(100, (totalPhosphorus / phosphorusTarget) * 100);
            phosphorusFill.style.width = `${phosphorusPercentage}%`;
            
            // Update potassium panel
            const potassiumPanel = document.querySelector('.nutrient-progress:nth-child(3)');
            const potassiumValue = potassiumPanel.querySelector('.progress-title span:last-child');
            const potassiumFill = potassiumPanel.querySelector('.progress-fill');
            
            potassiumValue.textContent = `${totalPotassium}/${potassiumTarget}mg`;
            let potassiumPercentage = Math.min(100, (totalPotassium / potassiumTarget) * 100);
            potassiumFill.style.width = `${potassiumPercentage}%`;
            
            // Update sodium panel
            const sodiumPanel = document.querySelector('.nutrient-progress:nth-child(4)');
            const sodiumValue = sodiumPanel.querySelector('.progress-title span:last-child');
            const sodiumFill = sodiumPanel.querySelector('.progress-fill');
            
            sodiumValue.textContent = `${totalSodium}/${sodiumTarget}mg`;
            let sodiumPercentage = Math.min(100, (totalSodium / sodiumTarget) * 100);
            sodiumFill.style.width = `${sodiumPercentage}%`;
            
            // Update color classes based on percentages
            potassiumFill.className = 'progress-fill';
            if (potassiumPercentage > 75) {
                potassiumFill.classList.add('warning');
            }
            
            sodiumFill.className = 'progress-fill';
            if (sodiumPercentage > 75) {
                sodiumFill.classList.add('warning');
            }
            if (sodiumPercentage > 90) {
                sodiumFill.classList.add('danger');
            }
            
            // Update Alma Score based on nutrition balance
            const almaScoreValue = document.querySelector('.alma-score-value');
            const almaScoreLabel = document.querySelector('.alma-score-label');
            
            // Calculate a score based on how balanced the nutrients are
            let score = 0;
            
            // Protein score (ideal: 80-100% of target)
            const proteinScore = proteinPercentage >= 80 && proteinPercentage <= 100 ? 25 : 
                                proteinPercentage > 100 ? 20 : 
                                Math.round((proteinPercentage / 80) * 25);
            
            // Phosphorus score (ideal: under 80% of target)
            const phosphorusScore = phosphorusPercentage <= 80 ? 25 : 
                                   Math.round((1 - (phosphorusPercentage - 80) / 20) * 25);
            
            // Potassium score (ideal: under 80% of target)
            const potassiumScore = potassiumPercentage <= 80 ? 25 : 
                                  Math.round((1 - (potassiumPercentage - 80) / 20) * 25);
            
            // Sodium score (ideal: under 75% of target)
            const sodiumScore = sodiumPercentage <= 75 ? 25 : 
                               Math.round((1 - (sodiumPercentage - 75) / 25) * 25);
            
            // Calculate total score
            score = proteinScore + phosphorusScore + potassiumScore + sodiumScore;
            
            // Default score for empty state
            if (mealCards.length === 0) {
                score = 0;
            }
            
            // Update UI
            almaScoreValue.textContent = score;
            
            // Update label based on score
            if (score >= 90) {
                almaScoreLabel.textContent = '优秀饮食习惯';
            } else if (score >= 75) {
                almaScoreLabel.textContent = '良好饮食习惯';
            } else if (score >= 60) {
                almaScoreLabel.textContent = '一般饮食习惯';
            } else if (score > 0) {
                almaScoreLabel.textContent = '需要改善饮食';
            } else {
                almaScoreLabel.textContent = '未记录饮食';
            }
        }
        
        // Function to show tooltip messages
        function showTooltip(message) {
            const tooltip = document.getElementById('tooltip');
            tooltip.textContent = message;
            tooltip.classList.add('visible');
            
            // Hide tooltip after 3 seconds
            setTimeout(() => {
                tooltip.classList.remove('visible');
            }, 3000);
        }
        
        // Initialize drag and drop functionality
        function initializeDragAndDrop() {
            const uploadLabel = document.querySelector('.upload-label');
            const uploadInput = document.getElementById('photoUpload');
            const uploadPreview = document.getElementById('uploadPreview');
            
            // Handle drag enter event
            uploadLabel.addEventListener('dragenter', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.classList.add('drag-over');
            });
            
            // Handle drag over event
            uploadLabel.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.classList.add('drag-over');
            });
            
            // Handle drag leave event
            uploadLabel.addEventListener('dragleave', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.classList.remove('drag-over');
            });
            
            // Handle drop event
            uploadLabel.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.classList.remove('drag-over');
                
                if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                    uploadInput.files = e.dataTransfer.files;
                    displayPreview(e.dataTransfer.files[0]);
                }
            });
            
            // Handle file input change
            uploadInput.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    displayPreview(this.files[0]);
                }
            });
            
            // Function to display preview of uploaded image
            function displayPreview(file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    uploadPreview.src = e.target.result;
                    uploadPreview.style.display = 'block';
                }
                reader.readAsDataURL(file);
            }
        }
        
        // Initialize dark mode toggle
        function initializeDarkMode() {
            const darkModeToggle = document.getElementById('darkModeToggle');
            
            // Check for saved theme preference or use user's system preference
            const savedTheme = localStorage.getItem('theme') || 
                (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            
            // Apply saved theme
            if (savedTheme === 'dark') {
                document.documentElement.classList.add('dark');
                darkModeToggle.innerHTML = '<i class="fas fa-sun"></i><span>切换浅色模式</span>';
            }
            
            // Add event listener to dark mode toggle button
            darkModeToggle.addEventListener('click', function() {
                document.documentElement.classList.toggle('dark');
                
                // Update button icon and text
                if (document.documentElement.classList.contains('dark')) {
                    this.innerHTML = '<i class="fas fa-sun"></i><span>切换浅色模式</span>';
                    localStorage.setItem('theme', 'dark');
                } else {
                    this.innerHTML = '<i class="fas fa-moon"></i><span>切换深色模式</span>';
                    localStorage.setItem('theme', 'light');
                }
            });
        }

        // Add delete meal card functionality
        function deleteMealCard(button) {
            if (confirm('确定要删除这条饮食记录吗？')) {
                const mealCard = button.closest('.meal-card');
                
                // Animate the deletion
                mealCard.style.transition = 'all 0.3s ease';
                mealCard.style.opacity = '0';
                mealCard.style.transform = 'translateX(100px)';
                
                // Remove the element after animation completes
                setTimeout(() => {
                    mealCard.remove();
                    showTooltip('饮食记录已删除');
                    
                    // If there are no more meal cards, show a message
                    const mealGrid = document.querySelector('.meal-grid');
                    if (mealGrid.children.length === 0) {
                        mealGrid.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-utensils"></i>
                                <h3 class="empty-state-title">没有饮食记录</h3>
                                <p class="empty-state-description">点击右下角的加号按钮添加您的第一条饮食记录</p>
                            </div>
                        `;
                    }
                    
                    // Update nutrition panels after deletion
                    updateNutritionPanels();
                }, 300);
            }
        }

        // Initialize the UI on load
        document.addEventListener('DOMContentLoaded', function() {
            // Reset nutrition panels to zero at startup since we now start with no meals
            updateNutritionPanels();
        });
    </script>
</body>
</html>